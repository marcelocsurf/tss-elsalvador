<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TSS ‚Äî The Surf Sequence¬Æ | El Salvador 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ============================================================
   TSS DESIGN SYSTEM ‚Äî id√©ntico al original
============================================================ */
:root{
  --bg:#050A0F;
  --bg2:#0A1018;
  --bg3:#0F1820;
  --cyan:#00C9E8;
  --cyan2:#00A8C4;
  --cyan3:rgba(0,201,232,.08);
  --green:#22C55E;
  --red:#EF4444;
  --amber:#F59E0B;
  --purple:#A855F7;
  --white:#E8F0F5;
  --grey:#6B8A9A;
  --border:rgba(0,201,232,.12);
  --border2:rgba(255,255,255,.06);
  --glass:rgba(255,255,255,.03);
  --r:14px;
  --r2:10px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;overflow-x:hidden;font-size:14px;line-height:1.5;max-width:480px;margin:0 auto;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 40% at 80% 10%,rgba(0,201,232,.06) 0%,transparent 60%),radial-gradient(ellipse 40% 60% at 10% 90%,rgba(0,168,196,.04) 0%,transparent 50%);pointer-events:none;z-index:0;}

/* LOADING */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9000;flex-direction:column;gap:16px;}
.spinner{width:36px;height:36px;border:3px solid rgba(0,201,232,.15);border-top-color:var(--cyan);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* TOAST */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--bg2);border:1px solid var(--cyan);color:var(--white);padding:10px 20px;border-radius:30px;font-size:13px;z-index:8000;transition:transform .3s ease;white-space:nowrap;max-width:90vw;}
#toast.show{transform:translateX(-50%) translateY(0);}
#toast.error{border-color:var(--red);color:var(--red);}
#toast.success{border-color:var(--green);color:var(--green);}

/* LANDING */
#landingScreen{display:none;position:relative;z-index:1;min-height:100vh;align-items:center;justify-content:center;flex-direction:column;padding:40px 24px;text-align:center;}
#landingScreen.active{display:flex;}
.tss-wave-svg{width:80px;height:58px;margin-bottom:14px;}
.tss-name{font-size:15px;font-weight:300;letter-spacing:4px;color:var(--white);text-transform:uppercase;margin-bottom:4px;}
.tss-tagline{font-size:12px;letter-spacing:2px;color:var(--cyan);font-weight:400;}

/* PIN PAD */
.pin-display{display:flex;gap:14px;justify-content:center;margin-bottom:20px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--grey);transition:all .2s;}
.pin-dot.filled{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 10px rgba(0,201,232,.5);}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:260px;margin:0 auto;}
.pin-btn{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r2);color:var(--white);font-size:20px;font-weight:700;padding:16px;cursor:pointer;transition:all .15s;font-family:'Space Mono',monospace;}
.pin-btn:active{background:rgba(0,201,232,.1);border-color:var(--border);transform:scale(.95);}
.pin-btn.del{font-size:16px;color:var(--grey);}
.pin-btn.zero{grid-column:2;}
#athPinErr{display:none;color:var(--red);font-size:12px;text-align:center;margin-top:10px;}

/* BUTTONS */
.btn{padding:14px 20px;border-radius:var(--r2);border:none;font-family:'Inter',sans-serif;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:9px;letter-spacing:.3px;width:100%;}
.btn-cyan{background:var(--cyan);color:#050A0F;}
.btn-cyan:hover{background:#00DCff;transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,201,232,.3);}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--white);}
.btn-outline:hover{border-color:var(--cyan);color:var(--cyan);}
.btn-ghost{background:var(--glass);border:1px solid var(--border2);color:var(--grey);}
.btn-green{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);color:var(--green);}
.btn-sm{padding:7px 14px;font-size:12px;border-radius:8px;width:auto;}
.btn-xs{padding:5px 10px;font-size:11px;border-radius:7px;width:auto;}

/* HEADER */
header{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid var(--border2);background:rgba(5,10,15,.9);backdrop-filter:blur(16px);position:sticky;top:0;z-index:200;}
.hdr-logo{display:flex;align-items:center;gap:8px;cursor:pointer;}
.hdr-logo-svg{width:28px;height:20px;flex-shrink:0;}
.hdr-logo-text{font-size:13px;font-weight:600;color:var(--white);letter-spacing:.5px;}
.hdr-logo-text span{display:block;font-size:9px;font-weight:400;color:var(--grey);letter-spacing:.5px;margin-top:-1px;}
.role-chip{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border-radius:20px;}
.rc-coach{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2);}
.rc-athlete{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2);}
.logout-btn{background:transparent;border:1px solid var(--border2);color:var(--grey);font-family:'Inter',sans-serif;font-size:11px;padding:5px 10px;border-radius:8px;cursor:pointer;}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:rgba(10,16,24,.95);border-top:1px solid var(--border2);backdrop-filter:blur(16px);display:flex;z-index:300;padding-bottom:env(safe-area-inset-bottom,0);}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px 4px 8px;cursor:pointer;border:none;background:none;color:var(--grey);font-size:9.5px;gap:4px;font-family:'Inter',sans-serif;font-weight:500;transition:color .2s;letter-spacing:.3px;}
.nav-btn .icon{font-size:20px;}
.nav-btn.active{color:var(--cyan);}

/* APP SHELL */
#appShell{display:none;position:relative;z-index:1;}
#appShell.active{display:block;}
#mainContent{padding:16px 14px 100px;min-height:calc(100vh - 52px);}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:16px;margin-bottom:10px;}
.card-cyan{background:rgba(0,201,232,.04);border-color:var(--border);}
.card-green{background:rgba(34,197,94,.04);border-color:rgba(34,197,94,.15);}

/* TYPOGRAPHY */
.sec-title{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--grey);font-family:'Space Mono',monospace;margin-bottom:10px;}
.page-title{font-size:20px;font-weight:800;color:var(--white);letter-spacing:-.5px;margin-bottom:2px;}
.page-sub{font-size:12px;color:var(--grey);margin-bottom:16px;}

/* CHIPS */
.chip{display:inline-flex;align-items:center;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 9px;border-radius:20px;}
.chip-cyan{background:rgba(0,201,232,.1);color:var(--cyan);border:1px solid rgba(0,201,232,.25);}
.chip-green{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2);}
.chip-red{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2);}
.chip-amber{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.2);}
.chip-grey{background:rgba(255,255,255,.05);color:var(--grey);border:1px solid rgba(255,255,255,.08);}

/* FORMS */
.inp-label{font-size:10px;font-weight:600;color:var(--grey);letter-spacing:.8px;text-transform:uppercase;margin-bottom:5px;margin-top:12px;display:block;}
.inp{width:100%;background:var(--glass);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;color:var(--white);font-family:'Inter',sans-serif;font-size:13px;outline:none;transition:border-color .2s;}
.inp:focus{border-color:var(--cyan);}
.inp::placeholder{color:rgba(255,255,255,.2);}
.ta{width:100%;background:var(--glass);border:1px solid var(--border2);border-radius:9px;padding:10px 13px;color:var(--white);font-family:'Inter',sans-serif;font-size:13px;outline:none;resize:none;min-height:64px;transition:border-color .2s;}
.ta:focus{border-color:var(--cyan);}
.ta::placeholder{color:rgba(255,255,255,.2);}
.sel{background:var(--glass);border:1px solid var(--border2);border-radius:9px;padding:9px 12px;color:var(--white);font-family:'Inter',sans-serif;font-size:13px;cursor:pointer;outline:none;appearance:none;width:100%;}
.sel:focus{border-color:var(--cyan);}
.sel option{background:var(--bg);}

/* SCALE BUTTONS */
.scale-row{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px;}
.se-n{width:36px;height:36px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:transparent;color:var(--grey);font-size:13px;font-weight:700;cursor:pointer;transition:all .13s;font-family:'Space Mono',monospace;display:flex;align-items:center;justify-content:center;}
.se-n:hover{border-color:var(--cyan);color:var(--cyan);}
.se-n.on{background:var(--cyan);border-color:var(--cyan);color:#050A0F;}

/* SAVE BTN */
.save-btn{width:100%;padding:14px;border-radius:var(--r2);border:none;background:var(--cyan);color:#050A0F;font-family:'Inter',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .18s;margin-top:8px;}
.save-btn:hover{background:#00DCff;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,201,232,.25);}

/* STAT GRID */
.stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.stat-box{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r2);padding:12px;text-align:center;}
.stat-n{font-size:28px;font-weight:800;color:var(--cyan);line-height:1;letter-spacing:-1px;font-family:'Space Mono',monospace;}
.stat-l{font-size:9px;color:var(--grey);margin-top:3px;letter-spacing:1px;text-transform:uppercase;}

/* ATHLETE ROW */
.ath-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r2);margin-bottom:7px;cursor:pointer;transition:border-color .15s;}
.ath-row:hover{border-color:var(--border);}
.ath-avatar{width:42px;height:42px;border-radius:50%;background:rgba(0,201,232,.1);border:1px solid rgba(0,201,232,.2);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:var(--cyan);flex-shrink:0;font-family:'Space Mono',monospace;}
.ath-info{flex:1;min-width:0;}
.ath-name{font-size:14px;font-weight:600;color:var(--white);}
.ath-meta{font-size:11px;color:var(--grey);margin-top:2px;}

/* STATUS */
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.dot-active{background:var(--green);}
.dot-inactive{background:var(--red);}

/* PROGRESS */
.prog-bar{height:4px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;margin-top:6px;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--cyan2));border-radius:4px;transition:width .5s ease;}

/* WEEK CARD */
.week-card{border-radius:var(--r);padding:16px;background:var(--bg2);border:1px solid var(--border2);margin-bottom:10px;}
.week-card.current{border-color:rgba(0,201,232,.35);background:rgba(0,201,232,.03);}
.week-n{font-size:32px;font-weight:800;color:var(--cyan);line-height:1;letter-spacing:-1px;font-family:'Space Mono',monospace;}
.week-dates{font-size:11px;color:var(--grey);margin-top:2px;}
.week-nav-row{display:flex;gap:8px;margin-bottom:14px;}
.nav-arrow{background:var(--glass);border:1px solid var(--border2);border-radius:8px;padding:7px 13px;color:var(--grey);font-size:11px;cursor:pointer;transition:all .15s;font-family:'Inter',sans-serif;}
.nav-arrow:hover{color:var(--cyan);border-color:var(--border);}
.current-badge{font-size:9px;background:var(--cyan);color:#050A0F;padding:2px 7px;border-radius:10px;font-weight:700;font-family:'Space Mono',monospace;letter-spacing:.5px;}

/* EVAL */
.eval-scores-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px;}
.eval-score-item{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r2);padding:10px;text-align:center;}
.eval-score-val{font-size:22px;font-weight:800;color:var(--amber);line-height:1;font-family:'Space Mono',monospace;}
.eval-score-name{font-size:9px;color:var(--grey);margin-top:3px;letter-spacing:.8px;text-transform:uppercase;}

/* WAVE SCORE */
.wave-score-wrap{text-align:center;padding:20px 0 14px;}
.score-ring{width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;}
.score-inner{width:88px;height:88px;background:var(--bg2);border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.score-n{font-size:26px;font-weight:800;color:var(--cyan);line-height:1;font-family:'Space Mono',monospace;}
.score-lbl{font-size:9px;color:var(--grey);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}

/* VIDEO */
.yt-embed{width:100%;padding-top:56.25%;position:relative;border-radius:var(--r2);overflow:hidden;margin-top:12px;}
.yt-embed iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none;}

/* INNER TABS */
.inner-tabs{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.inner-tabs::-webkit-scrollbar{display:none;}
.itab{flex-shrink:0;padding:7px 13px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:var(--grey);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap;font-family:'Inter',sans-serif;}
.itab.active{background:rgba(0,201,232,.1);border-color:rgba(0,201,232,.25);color:var(--cyan);}

/* INTENSITY BAR */
.intensity-bar{height:4px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;margin-top:8px;}
.intensity-fill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--green));border-radius:4px;}

/* ALERT */
.alert{padding:12px 14px;border-radius:var(--r2);font-size:12px;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
.alert-amber{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);color:var(--amber);}

/* EMPTY */
.empty{text-align:center;padding:40px 24px;}
.empty-icon{font-size:44px;margin-bottom:12px;}
.empty-txt{font-size:13px;color:var(--grey);line-height:1.6;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:600;display:flex;align-items:flex-end;backdrop-filter:blur(8px);}
.modal-sheet{background:var(--bg2);border:1px solid var(--border);border-radius:20px 20px 0 0;padding:24px 20px 40px;width:100%;max-width:480px;margin:0 auto;max-height:92vh;overflow-y:auto;}
.modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.modal-title{font-size:18px;font-weight:800;color:var(--white);letter-spacing:-.3px;}
.modal-sub{font-size:11px;color:var(--grey);margin-top:2px;}
.modal-close{background:transparent;border:1px solid var(--border2);color:var(--grey);width:30px;height:30px;border-radius:8px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

/* ANIMATION */
@keyframes up{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.anim-up{animation:up .2s ease;}

/* COPYRIGHT */
.copyright-block{margin:28px 0 0;padding:14px 16px;border-top:1px solid rgba(0,201,232,.1);font-size:9.5px;color:#4A6070;line-height:1.7;text-align:center;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <svg style="width:60px;height:44px;" viewBox="0 0 120 88" fill="none">
    <path d="M8 80 C8 80 8 8 75 8 C110 8 114 38 114 48 C114 68 96 76 80 70 C65 65 62 52 70 44 C76 38 84 40 86 48 C88 55 82 60 76 56" stroke="#00C9E8" stroke-width="5" stroke-linecap="round" fill="#00C9E8" fill-opacity="0.12"/>
  </svg>
  <div class="spinner"></div>
  <p style="color:var(--grey);font-size:11px;letter-spacing:1.5px;font-family:'Space Mono',monospace;">CARGANDO TSS...</p>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- ============================================================
     LANDING
============================================================ -->
<div id="landingScreen">
  <!-- LOGO -->
  <div style="margin-bottom:32px;">
    <svg class="tss-wave-svg" viewBox="0 0 120 88" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 80 C8 80 8 8 75 8 C110 8 114 38 114 48 C114 68 96 76 80 70 C65 65 62 52 70 44 C76 38 84 40 86 48 C88 55 82 60 76 56" stroke="#00C9E8" stroke-width="5" stroke-linecap="round" fill="#00C9E8" fill-opacity="0.12"/>
    </svg>
    <div class="tss-name">The Surf Sequence</div>
    <div class="tss-tagline">Evolve through play</div>
  </div>
  <div style="font-size:13px;color:var(--grey);margin-bottom:8px;line-height:1.7;">Equipo El Salvador ¬∑ Temporada 2026</div>
  <div style="margin-bottom:32px;font-size:11px;color:#4A6070;letter-spacing:1px;">by Marcelo Castellanos</div>

  <!-- ROLE BUTTONS -->
  <div id="roleButtons" style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:300px;">
    <button class="btn btn-cyan" onclick="showPin('coach')">üèÜ Coach</button>
    <button class="btn btn-green" onclick="showPin('athlete')">üåä Atleta</button>
  </div>

  <!-- PIN PAD -->
  <div id="pinPad" style="display:none;width:100%;max-width:300px;">
    <div class="sec-title" style="text-align:center;margin-bottom:16px;" id="pinTitle">INGRESA TU PIN</div>
    <div class="pin-display">
      <div class="pin-dot" id="pd0"></div>
      <div class="pin-dot" id="pd1"></div>
      <div class="pin-dot" id="pd2"></div>
      <div class="pin-dot" id="pd3"></div>
    </div>
    <div class="pin-grid">
      <button class="pin-btn" onclick="pp('1')">1</button>
      <button class="pin-btn" onclick="pp('2')">2</button>
      <button class="pin-btn" onclick="pp('3')">3</button>
      <button class="pin-btn" onclick="pp('4')">4</button>
      <button class="pin-btn" onclick="pp('5')">5</button>
      <button class="pin-btn" onclick="pp('6')">6</button>
      <button class="pin-btn" onclick="pp('7')">7</button>
      <button class="pin-btn" onclick="pp('8')">8</button>
      <button class="pin-btn" onclick="pp('9')">9</button>
      <button class="pin-btn zero" onclick="pp('0')">0</button>
      <button class="pin-btn del" onclick="pd()">‚å´</button>
    </div>
    <div id="athPinErr">PIN incorrecto. Intenta de nuevo.</div>
    <button class="btn btn-ghost" style="margin-top:16px;" onclick="backToRoles()">‚Üê Volver</button>
  </div>

  <div class="copyright-block">
    <span style="color:var(--cyan);font-weight:700;font-size:10px;">¬© TSS ‚Äî The Surf Sequence¬Æ</span><br>
    Propiedad intelectual exclusiva de <strong style="color:var(--grey);">Marcelo Castellanos</strong>. Todos los derechos reservados.<br>
    El uso no autorizado constituye una violaci√≥n de los derechos de propiedad intelectual.
  </div>
</div>

<!-- ============================================================
     APP SHELL
============================================================ -->
<div id="appShell">
  <header>
    <div class="hdr-logo" onclick="goHome()">
      <svg class="hdr-logo-svg" viewBox="0 0 120 88" fill="none">
        <path d="M8 80 C8 80 8 8 75 8 C110 8 114 38 114 48 C114 68 96 76 80 70 C65 65 62 52 70 44 C76 38 84 40 86 48 C88 55 82 60 76 56" stroke="#00C9E8" stroke-width="6" stroke-linecap="round" fill="#00C9E8" fill-opacity="0.15"/>
      </svg>
      <div class="hdr-logo-text">TSS¬Æ <span id="headerSub">El Salvador</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span class="role-chip" id="roleChip"></span>
      <button class="logout-btn" onclick="goHome()">Salir</button>
    </div>
  </header>
  <div id="mainContent"></div>
  <nav class="bottom-nav" id="bottomNav"></nav>
</div>

<script>
/* ============================================================
   SUPABASE CONFIG
   üëá REEMPLAZA CON TUS CREDENCIALES
============================================================ */
const SUPABASE_URL = 'https://pfbsmzpvbkltkoozTlyc.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmYnNtenB2YmtsdGtvb3p0bHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NDM1NzAsImV4cCI6MjA4NzIxOTU3MH0.CyVI3p54VLkvj2LgSsqIA_9d4BkJG8zn0fEzO_lrHvM';

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

/* STATE */
let S = { user:null, pin:'', athletes:[], view:null };

/* UTILS */
function showLoad(v){ document.getElementById('loading').style.display=v?'flex':'none'; }
let _tt;
function toast(msg,type='info'){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`show ${type}`;
  clearTimeout(_tt); _tt=setTimeout(()=>{el.className='';},3000);
}
function ytId(url){
  if(!url) return null;
  const m=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/);
  return m?m[1]:null;
}
function fmtDate(d){ if(!d) return '‚Äî'; return new Date(d+'T00:00:00').toLocaleDateString('es-SV',{day:'2-digit',month:'short',year:'numeric'}); }
function daysSince(ds){ if(!ds) return 999; return Math.floor((Date.now()-new Date(ds).getTime())/86400000); }
function getWeekNum(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dn=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dn); const ys=new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d-ys)/86400000)+1)/7); }
function getWeekDates(w,y){ const jan1=new Date(y,0,1); const dow=jan1.getDay()||7; const mon=new Date(jan1); mon.setDate(jan1.getDate()+(8-dow)%7); const start=new Date(mon); start.setDate(mon.getDate()+(w-1)*7); const end=new Date(start); end.setDate(start.getDate()+6); const f=d=>d.toLocaleDateString('es-SV',{day:'2-digit',month:'short'}); return{start,end,label:`${f(start)} ‚Äì ${f(end)}`}; }
function render(html){ document.getElementById('mainContent').innerHTML=html; }
function scaleRow(name,val=0){ let b=''; for(let i=1;i<=10;i++) b+=`<button type="button" class="se-n${i===val?' on':''}" onclick="pickScale('${name}',${i},this)">${i}</button>`; return `<div class="scale-row">${b}</div><input type="hidden" id="sc-${name}" value="${val}">`; }
function pickScale(name,val,btn){ btn.closest('.scale-row').querySelectorAll('.se-n').forEach(b=>b.classList.remove('on')); btn.classList.add('on'); document.getElementById(`sc-${name}`).value=val; }
function gv(id){ const e=document.getElementById(id); return e?e.value.trim():''; }

/* ============================================================
   LOGIN
============================================================ */
function showPin(role){
  S.pin=''; S.loginRole=role;
  document.getElementById('roleButtons').style.display='none';
  document.getElementById('pinPad').style.display='block';
  document.getElementById('pinTitle').textContent=role==='coach'?'PIN DE COACH':'INGRESA TU PIN';
  document.getElementById('athPinErr').style.display='none';
  updateDots();
}
function backToRoles(){
  S.pin='';
  document.getElementById('roleButtons').style.display='flex';
  document.getElementById('pinPad').style.display='none';
  document.getElementById('athPinErr').style.display='none';
}
function pp(d){ if(S.pin.length>=4) return; S.pin+=d; updateDots(); if(S.pin.length===4) setTimeout(tryLogin,100); }
function pd(){ S.pin=S.pin.slice(0,-1); updateDots(); document.getElementById('athPinErr').style.display='none'; }
function updateDots(){ for(let i=0;i<4;i++) document.getElementById(`pd${i}`).className='pin-dot'+(i<S.pin.length?' filled':''); }

async function tryLogin(){
  const pin=S.pin; S.pin=''; updateDots();
  showLoad(true);
  try {
    const { data,error } = await db.from('tss_profiles').select('*').eq('pin',pin);
    if(error) throw error;
    if(!data||!data.length){ document.getElementById('athPinErr').style.display='block'; return; }
    S.user=data[0]; localStorage.setItem('tss_uid',S.user.id);
    await bootApp();
  } catch(e){ toast('Error de conexi√≥n','error'); console.error(e); }
  finally { showLoad(false); }
}

async function restoreSession(){
  const uid=localStorage.getItem('tss_uid'); if(!uid) return false;
  try { const{data}=await db.from('tss_profiles').select('*').eq('id',uid).single(); if(!data) return false; S.user=data; return true; } catch{ return false; }
}

function goHome(){
  localStorage.removeItem('tss_uid'); S.user=null; S.athletes=[];
  document.getElementById('appShell').style.display='none';
  document.getElementById('landingScreen').style.display='flex';
  document.getElementById('roleButtons').style.display='flex';
  document.getElementById('pinPad').style.display='none';
}

/* ============================================================
   BOOT APP
============================================================ */
async function bootApp(){
  const{data}=await db.from('tss_profiles').select('*').eq('role','athlete').order('name');
  S.athletes=data||[];
  const isCoach=S.user.role==='coach';
  document.getElementById('landingScreen').style.display='none';
  document.getElementById('appShell').style.display='block';
  document.getElementById('roleChip').textContent=isCoach?'Coach':S.user.name;
  document.getElementById('roleChip').className=`role-chip ${isCoach?'rc-coach':'rc-athlete'}`;
  document.getElementById('headerSub').textContent=isCoach?'Coach Panel':'El Salvador';
  buildNav();
  switchView(isCoach?'panel':'sesiones');
}

function buildNav(){
  const isCoach=S.user.role==='coach';
  const tabs=isCoach
    ?[{id:'panel',icon:'üìä',lbl:'Panel'},{id:'calendario',icon:'üìÖ',lbl:'Calendario'},{id:'evaluar',icon:'‚≠ê',lbl:'Evaluar'},{id:'atletas',icon:'üë•',lbl:'Atletas'}]
    :[{id:'sesiones',icon:'üåä',lbl:'Sesiones'},{id:'calendario',icon:'üìÖ',lbl:'Calendario'},{id:'perfil',icon:'üë§',lbl:'Mi Perfil'}];
  document.getElementById('bottomNav').innerHTML=tabs.map(t=>
    `<button class="nav-btn" id="nb-${t.id}" onclick="switchView('${t.id}')"><span class="icon">${t.icon}</span><span>${t.lbl}</span></button>`).join('');
}

function switchView(view){
  S.view=view;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById(`nb-${view}`); if(btn) btn.classList.add('active');
  ({sesiones:vSesiones,calendario:vCalendario,perfil:vPerfil,panel:vPanel,evaluar:vEvaluar,atletas:vAtletas})[view]?.();
}

/* ============================================================
   M1 ‚Äî SESIONES
============================================================ */
function vSesiones(){
  render(`<div class="page-title">Mis Sesiones</div><div class="page-sub">Registra y revisa tu entrenamiento</div>
    <div class="inner-tabs"><button class="itab active" id="it-reg" onclick="sTab('reg')">+ Registrar</button><button class="itab" id="it-hist" onclick="sTab('hist')">Historial</button></div>
    <div id="sesTab"></div>`);
  sTab('reg');
}
function sTab(t){
  document.querySelectorAll('.itab').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById(`it-${t}`); if(el) el.classList.add('active');
  if(t==='reg') renderSesForm(); else loadSesHist();
}
function renderSesForm(){
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('sesTab').innerHTML=`<div class="card anim-up">
    <label class="inp-label">Fecha</label><input type="date" class="inp" id="sd" value="${today}">
    <label class="inp-label">Tipo de Entrenamiento</label>
    <select class="sel" id="st">${['Surf en agua','Surf en piscina','F√≠sico - Fuerza','F√≠sico - Cardio','T√©cnica en seco','Flexibilidad / Movilidad','Mental / Visualizaci√≥n','Competencia','Otro'].map(t=>`<option>${t}</option>`).join('')}</select>
    <label class="inp-label">Duraci√≥n (minutos)</label><input type="number" class="inp" id="sdur" placeholder="90" min="1">
    <label class="inp-label">Intensidad (1‚Äì10)</label>${scaleRow('si')}
    <label class="inp-label">Notas</label><textarea class="ta" id="sn" placeholder="¬øC√≥mo estuvo la sesi√≥n?"></textarea>
    <label class="inp-label">Video YouTube (opcional)</label><input type="url" class="inp" id="sv" placeholder="https://youtube.com/...">
    <button class="save-btn" style="margin-top:16px;" onclick="saveSes()">üíæ Guardar Sesi√≥n</button>
  </div>`;
}
async function saveSes(){
  const intensity=parseInt(gv('sc-si')||0),duration=parseInt(gv('sdur')||0);
  if(!intensity){toast('Selecciona la intensidad','error');return;}
  if(!duration){toast('Ingresa la duraci√≥n','error');return;}
  showLoad(true);
  try {
    const{error}=await db.from('tss_sessions').insert({athlete_id:S.user.id,date:gv('sd'),type:gv('st'),duration,intensity,notes:gv('sn'),video_url:gv('sv')||null});
    if(error) throw error;
    toast('‚úÖ Sesi√≥n guardada','success'); sTab('hist');
  } catch(e){toast('Error al guardar','error');console.error(e);}
  finally{showLoad(false);}
}
async function loadSesHist(athleteId=null,containerId='sesTab'){
  const id=athleteId||S.user.id;
  const container=document.getElementById(containerId); if(!container) return;
  container.innerHTML='<p style="padding:20px;text-align:center;color:var(--grey);font-size:12px;">Cargando...</p>';
  try {
    const{data,error}=await db.from('tss_sessions').select('*').eq('athlete_id',id).order('date',{ascending:false}).limit(50);
    if(error) throw error;
    if(!data.length){container.innerHTML=`<div class="empty"><div class="empty-icon">üåä</div><p class="empty-txt">Sin sesiones registradas a√∫n</p></div>`;return;}
    container.innerHTML=data.map(s=>{
      const vid=ytId(s.video_url);
      return `<div class="card anim-up">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
          <div><div style="font-size:14px;font-weight:700;">${s.type}</div><div style="font-size:11px;color:var(--grey);margin-top:2px;">${fmtDate(s.date)} ¬∑ ${s.duration} min</div></div>
          <span class="chip chip-cyan">Int. ${s.intensity}/10</span>
        </div>
        <div class="intensity-bar"><div class="intensity-fill" style="width:${s.intensity*10}%"></div></div>
        ${s.notes?`<p style="font-size:12px;color:rgba(232,240,245,.6);margin-top:10px;line-height:1.6;">${s.notes}</p>`:''}
        ${vid?`<div class="yt-embed"><iframe src="https://www.youtube.com/embed/${vid}" allowfullscreen></iframe></div>`:''}
      </div>`;
    }).join('');
  } catch(e){container.innerHTML='<p style="padding:20px;text-align:center;color:var(--red);font-size:12px;">Error al cargar</p>';}
}

/* ============================================================
   M2 ‚Äî EVALUACIONES
============================================================ */
function vEvaluar(){
  render(`<div class="page-title">Evaluar Atleta</div><div class="page-sub">Registra evaluaciones formales</div>
    <label class="inp-label">Seleccionar Atleta</label>
    <select class="sel" id="eaSel" onchange="loadEvalForm()" style="margin-bottom:16px;"><option value="">‚Äî Elige un atleta ‚Äî</option>${S.athletes.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
    <div id="evalFormArea"></div>
    <div style="height:1px;background:var(--border2);margin:20px 0;"></div>
    <div class="sec-title">Historial por Atleta</div>
    <select class="sel" id="eaHistSel" onchange="loadEvalHist()" style="margin-bottom:12px;"><option value="">‚Äî Ver historial ‚Äî</option>${S.athletes.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}</select>
    <div id="evalHistArea"></div>`);
}
function loadEvalForm(){
  const id=gv('eaSel'); if(!id){document.getElementById('evalFormArea').innerHTML='';return;}
  const today=new Date().toISOString().split('T')[0];
  document.getElementById('evalFormArea').innerHTML=`<div class="card card-cyan anim-up">
    <label class="inp-label">Fecha</label><input type="date" class="inp" id="evDate" value="${today}">
    <label class="inp-label">Condici√≥n F√≠sica</label>${scaleRow('phys')}
    <label class="inp-label">T√©cnica</label>${scaleRow('tech')}
    <label class="inp-label">Mentalidad</label>${scaleRow('mind')}
    <label class="inp-label">Rendimiento Competitivo ‚≠ê</label>${scaleRow('comp')}
    <label class="inp-label">Fortalezas</label><textarea class="ta" id="evStr" placeholder="Puntos fuertes..."></textarea>
    <label class="inp-label">Limitaciones</label><textarea class="ta" id="evLim" placeholder="√Åreas a trabajar..."></textarea>
    <label class="inp-label">Recomendaciones</label><textarea class="ta" id="evRec" placeholder="Plan de acci√≥n..."></textarea>
    <button class="save-btn" style="margin-top:16px;" onclick="saveEval('${id}')">üíæ Guardar Evaluaci√≥n</button>
  </div>`;
}
async function saveEval(athleteId){
  const p=parseInt(gv('sc-phys')||0),t=parseInt(gv('sc-tech')||0),m=parseInt(gv('sc-mind')||0),c=parseInt(gv('sc-comp')||0);
  if(!p||!t||!m||!c){toast('Completa todos los puntajes','error');return;}
  showLoad(true);
  try {
    const{error}=await db.from('tss_evaluations').insert({athlete_id:athleteId,coach_id:S.user.id,date:gv('evDate'),physical:p,technique:t,mindset:m,competitive:c,strengths:gv('evStr'),limitations:gv('evLim'),recommendations:gv('evRec')});
    if(error) throw error;
    toast('‚úÖ Evaluaci√≥n guardada','success');
    document.getElementById('eaSel').value=''; document.getElementById('evalFormArea').innerHTML='';
  } catch(e){toast('Error al guardar','error');console.error(e);}
  finally{showLoad(false);}
}
async function loadEvalHist(){
  const id=gv('eaHistSel'); const el=document.getElementById('evalHistArea');
  if(!id){el.innerHTML='';return;}
  el.innerHTML='<p style="padding:16px;text-align:center;color:var(--grey);font-size:12px;">Cargando...</p>';
  try {
    const{data,error}=await db.from('tss_evaluations').select('*').eq('athlete_id',id).order('date',{ascending:false});
    if(error) throw error;
    if(!data.length){el.innerHTML='<p style="padding:16px;text-align:center;color:var(--grey);font-size:12px;">Sin evaluaciones a√∫n</p>';return;}
    el.innerHTML=data.map(ev=>`<div class="card anim-up">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div style="font-size:12px;color:var(--grey);">${fmtDate(ev.date)}</div>
        <div style="font-family:'Space Mono',monospace;font-size:18px;font-weight:800;color:var(--cyan);">${((ev.physical+ev.technique+ev.mindset+ev.competitive)/4).toFixed(1)}/10</div>
      </div>
      <div class="eval-scores-grid">
        <div class="eval-score-item"><div class="eval-score-val">${ev.physical}</div><div class="eval-score-name">F√≠sico</div></div>
        <div class="eval-score-item"><div class="eval-score-val">${ev.technique}</div><div class="eval-score-name">T√©cnica</div></div>
        <div class="eval-score-item"><div class="eval-score-val">${ev.mindset}</div><div class="eval-score-name">Mentalidad</div></div>
        <div class="eval-score-item"><div class="eval-score-val" style="color:var(--cyan);">${ev.competitive}</div><div class="eval-score-name">Competitivo ‚≠ê</div></div>
      </div>
      ${ev.strengths?`<p style="font-size:12px;color:var(--green);margin-top:8px;">üí™ ${ev.strengths}</p>`:''}
      ${ev.limitations?`<p style="font-size:12px;color:var(--red);margin-top:4px;">‚ö†Ô∏è ${ev.limitations}</p>`:''}
      ${ev.recommendations?`<p style="font-size:12px;color:var(--grey);margin-top:4px;">üìã ${ev.recommendations}</p>`:''}
    </div>`).join('');
  } catch(e){el.innerHTML='<p style="padding:16px;text-align:center;color:var(--red);font-size:12px;">Error</p>';}
}

/* ============================================================
   M3 ‚Äî CALENDARIO
============================================================ */
let calOffset=0;
function vCalendario(){
  const isCoach=S.user.role==='coach';
  render(`<div class="page-title">Calendario 2026</div><div class="page-sub">Plan semanal de entrenamiento</div>
    <div class="week-nav-row">
      <button class="nav-arrow" onclick="calNav(-1)">‚Üê Anterior</button>
      <button class="nav-arrow" onclick="calNav(0)">Hoy</button>
      <button class="nav-arrow" onclick="calNav(1)">Siguiente ‚Üí</button>
    </div><div id="calContent"></div>`);
  calOffset=0; loadCal(isCoach);
}
function calNav(dir){ if(dir===0)calOffset=0; else calOffset+=dir; loadCal(S.user.role==='coach'); }
async function loadCal(isCoach){
  const el=document.getElementById('calContent'); if(!el) return;
  el.innerHTML='<p style="padding:20px;text-align:center;color:var(--grey);font-size:12px;">Cargando...</p>';
  const cw=getWeekNum(new Date()); const start=Math.max(1,cw+calOffset);
  const weeks=[]; for(let w=start;w<start+5&&w<=52;w++) weeks.push(w);
  try {
    const{data}=await db.from('tss_weekly_plans').select('*').eq('year',2026).in('week_number',weeks);
    const plans={}; (data||[]).forEach(p=>plans[p.week_number]=p);
    el.innerHTML=weeks.map(w=>{
      const wd=getWeekDates(w,2026); const plan=plans[w]; const cur=w===cw;
      return `<div class="week-card${cur?' current':''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
          <div><div class="week-n">W${w}</div><div class="week-dates">${wd.label}</div></div>
          <div style="display:flex;gap:6px;align-items:center;">
            ${cur?'<span class="current-badge">HOY</span>':''}
            ${isCoach?`<button class="btn btn-xs btn-outline" onclick="editWeek(${w})">‚úèÔ∏è Editar</button>`:''}
          </div>
        </div>
        ${plan?`<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border2);">
          ${plan.objective?`<p style="font-size:13px;font-weight:600;margin-bottom:8px;">üéØ ${plan.objective}</p>`:''}
          ${plan.work_type?`<span class="chip chip-cyan">${plan.work_type}</span>`:''}
          ${plan.notes?`<p style="font-size:12px;color:rgba(232,240,245,.5);margin-top:8px;line-height:1.6;">${plan.notes}</p>`:''}
        </div>`:`<p style="font-size:12px;color:rgba(255,255,255,.2);margin-top:10px;">${isCoach?'Sin plan ‚Äî Toca ‚úèÔ∏è Editar':'El coach a√∫n no public√≥ el plan de esta semana.'}</p>`}
      </div>`;
    }).join('');
  } catch(e){el.innerHTML='<p style="padding:20px;text-align:center;color:var(--red);font-size:12px;">Error</p>';}
}
async function editWeek(w){
  const{data}=await db.from('tss_weekly_plans').select('*').eq('week_number',w).eq('year',2026).single().catch(()=>({data:null}));
  const plan=data||{}; const wd=getWeekDates(w,2026);
  const m=document.createElement('div'); m.className='modal-overlay'; m.id='weekModal';
  m.innerHTML=`<div class="modal-sheet">
    <div class="modal-head">
      <div><div class="modal-title">Semana ${w}</div><div class="modal-sub">${wd.label}</div></div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <label class="inp-label">Objetivo</label><textarea class="ta" id="wpObj" placeholder="¬øQu√© se busca?">${plan.objective||''}</textarea>
    <label class="inp-label">Tipo de Trabajo</label>
    <select class="sel" id="wpType">${['T√©cnica','Fuerza','Cardio','Competencia','Recuperaci√≥n','Evaluaci√≥n','Mixto','Otro'].map(t=>`<option${plan.work_type===t?' selected':''}>${t}</option>`).join('')}</select>
    <label class="inp-label">Notas</label><textarea class="ta" id="wpNotes" placeholder="Detalles...">${plan.notes||''}</textarea>
    <button class="save-btn" onclick="saveWeek(${w},'${plan.id||''}')">üíæ Guardar Plan</button>
  </div>`;
  document.body.appendChild(m);
  m.onclick=e=>{ if(e.target===m) closeModal(); };
}
function closeModal(){ const m=document.getElementById('weekModal'); if(m) m.remove(); }
async function saveWeek(w,existId){
  const payload={week_number:w,year:2026,objective:gv('wpObj'),work_type:gv('wpType'),notes:gv('wpNotes'),created_by:S.user.id};
  showLoad(true);
  try {
    const{error}=existId?await db.from('tss_weekly_plans').update(payload).eq('id',existId):await db.from('tss_weekly_plans').insert(payload);
    if(error) throw error;
    toast('‚úÖ Plan guardado','success'); closeModal(); loadCal(true);
  } catch(e){toast('Error','error');console.error(e);}
  finally{showLoad(false);}
}

/* ============================================================
   M4 ‚Äî PANEL COACH
============================================================ */
async function vPanel(){
  render(`<div class="page-title">Panel del Coach</div><div class="page-sub">Estado del equipo ¬∑ TSS El Salvador</div>
    <div id="panelContent"><p style="padding:20px;text-align:center;color:var(--grey);font-size:12px;">Cargando...</p></div>`);
  try {
    const[{data:sessions},{data:evals}]=await Promise.all([
      db.from('tss_sessions').select('athlete_id,date').order('date',{ascending:false}),
      db.from('tss_evaluations').select('athlete_id,competitive'),
    ]);
    const lastSes={}; (sessions||[]).forEach(s=>{if(!lastSes[s.athlete_id])lastSes[s.athlete_id]=s.date;});
    const scoreSum={},scoreCount={};
    (evals||[]).forEach(e=>{scoreSum[e.athlete_id]=(scoreSum[e.athlete_id]||0)+e.competitive;scoreCount[e.athlete_id]=(scoreCount[e.athlete_id]||0)+1;});
    const active=S.athletes.filter(a=>daysSince(lastSes[a.id])<=7).length;
    const inactive=S.athletes.length-active;
    document.getElementById('panelContent').innerHTML=`
      <div class="stat-grid" style="margin-bottom:14px;">
        <div class="stat-box"><div class="stat-n">${S.athletes.length}</div><div class="stat-l">Atletas</div></div>
        <div class="stat-box"><div class="stat-n" style="color:var(--green)">${active}</div><div class="stat-l">Activos</div></div>
        <div class="stat-box"><div class="stat-n" style="color:var(--red)">${inactive}</div><div class="stat-l">Inactivos</div></div>
      </div>
      ${inactive?`<div class="alert alert-amber">‚ö†Ô∏è ${inactive} atleta(s) sin actividad en 7 d√≠as</div>`:''}
      <div class="sec-title">Estado del Equipo</div>
      ${S.athletes.map(a=>{
        const days=daysSince(lastSes[a.id]);
        const ws=scoreCount[a.id]?(scoreSum[a.id]/scoreCount[a.id]).toFixed(1):'‚Äî';
        return `<div class="ath-row" onclick="openAthProfile('${a.id}','${a.name}')">
          <div class="ath-avatar">${a.name.charAt(0)}</div>
          <div class="ath-info">
            <div class="ath-name">${a.name}</div>
            <div class="ath-meta">${lastSes[a.id]?`√öltima: ${fmtDate(lastSes[a.id])}`:'Sin sesiones'} ¬∑ Wave Score: <span style="color:var(--cyan);">${ws}</span></div>
            <div class="prog-bar"><div class="prog-fill" style="width:${scoreCount[a.id]?Math.min(100,(scoreSum[a.id]/scoreCount[a.id])*10):0}%"></div></div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
            <div class="status-dot ${days<=7?'dot-active':'dot-inactive'}"></div>
            <span style="color:var(--grey);font-size:18px;">‚Ä∫</span>
          </div>
        </div>`;
      }).join('')}`;
  } catch(e){document.getElementById('panelContent').innerHTML='<p style="padding:20px;text-align:center;color:var(--red);font-size:12px;">Error</p>';}
}

/* ============================================================
   M5 ‚Äî PERFIL
============================================================ */
async function vPerfil(athleteId=null,athleteName=null){
  const id=athleteId||S.user.id; const name=athleteName||S.user.name;
  render(`<div style="display:flex;align-items:center;gap:12px;margin-bottom:4px;">
    <div class="ath-avatar" style="width:52px;height:52px;font-size:22px;">${name.charAt(0)}</div>
    <div><div class="page-title" style="margin-bottom:0;">${name}</div><div class="page-sub" style="margin-bottom:0;">Perfil ¬∑ TSS El Salvador</div></div>
  </div><div id="perfilContent" style="margin-top:14px;"><p style="padding:20px;text-align:center;color:var(--grey);font-size:12px;">Cargando...</p></div>`);
  try {
    const[{data:sessions},{data:evals}]=await Promise.all([
      db.from('tss_sessions').select('*').eq('athlete_id',id).order('date',{ascending:false}).limit(5),
      db.from('tss_evaluations').select('*').eq('athlete_id',id).order('date',{ascending:false}),
    ]);
    const scores=(evals||[]).map(e=>e.competitive).filter(Boolean);
    const waveScore=scores.length?(scores.reduce((a,b)=>a+b,0)/scores.length):0;
    const pct=waveScore/10*100;
    document.getElementById('perfilContent').innerHTML=`
      <div class="card card-cyan wave-score-wrap">
        <div class="score-ring" style="background:conic-gradient(var(--cyan) ${pct}%,rgba(0,201,232,.08) 0%);">
          <div class="score-inner">
            <div class="score-n">${waveScore?waveScore.toFixed(1):'‚Äî'}</div>
            <div class="score-lbl">WAVE SCORE</div>
          </div>
        </div>
        <div style="font-size:12px;color:var(--grey);">Rendimiento competitivo promedio</div>
        <div style="font-size:10px;color:#4A6070;margin-top:4px;">${scores.length} evaluaci√≥n(es) del coach</div>
      </div>
      <div class="stat-grid">
        <div class="stat-box"><div class="stat-n">${sessions?.length||0}</div><div class="stat-l">Sesiones</div></div>
        <div class="stat-box"><div class="stat-n">${evals?.length||0}</div><div class="stat-l">Evaluaciones</div></div>
        <div class="stat-box"><div class="stat-n">${sessions?.length?sessions[0].intensity:'‚Äî'}</div><div class="stat-l">√öltima Int.</div></div>
      </div>
      <div class="sec-title" style="margin-top:14px;">Sesiones Recientes</div>
      ${(sessions||[]).length?sessions.map(s=>`
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div><div style="font-size:13px;font-weight:700;">${s.type}</div><div style="font-size:11px;color:var(--grey);margin-top:2px;">${fmtDate(s.date)} ¬∑ ${s.duration} min</div></div>
            <span class="chip chip-cyan">Int. ${s.intensity}</span>
          </div>
          <div class="intensity-bar"><div class="intensity-fill" style="width:${s.intensity*10}%"></div></div>
        </div>`).join(''):`<div class="empty" style="padding:24px 0;"><p class="empty-txt">Sin sesiones recientes</p></div>`}
      ${evals?.length?`
        <div class="sec-title" style="margin-top:14px;">√öltima Evaluaci√≥n</div>
        <div class="card card-cyan">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:12px;color:var(--grey);">${fmtDate(evals[0].date)}</div>
            <div style="font-family:'Space Mono',monospace;font-size:18px;font-weight:800;color:var(--cyan);">${((evals[0].physical+evals[0].technique+evals[0].mindset+evals[0].competitive)/4).toFixed(1)}/10</div>
          </div>
          <div class="eval-scores-grid">
            <div class="eval-score-item"><div class="eval-score-val">${evals[0].physical}</div><div class="eval-score-name">F√≠sico</div></div>
            <div class="eval-score-item"><div class="eval-score-val">${evals[0].technique}</div><div class="eval-score-name">T√©cnica</div></div>
            <div class="eval-score-item"><div class="eval-score-val">${evals[0].mindset}</div><div class="eval-score-name">Mentalidad</div></div>
            <div class="eval-score-item"><div class="eval-score-val" style="color:var(--cyan);">${evals[0].competitive}</div><div class="eval-score-name">Competitivo ‚≠ê</div></div>
          </div>
          ${evals[0].strengths?`<p style="font-size:12px;color:var(--green);margin-top:8px;">üí™ ${evals[0].strengths}</p>`:''}
          ${evals[0].limitations?`<p style="font-size:12px;color:var(--red);margin-top:4px;">‚ö†Ô∏è ${evals[0].limitations}</p>`:''}
          ${evals[0].recommendations?`<p style="font-size:12px;color:var(--grey);margin-top:4px;">üìã ${evals[0].recommendations}</p>`:''}
        </div>`:''}
      ${athleteId?`<button class="btn btn-ghost" style="margin-top:12px;" onclick="switchView('panel')">‚Üê Volver al Panel</button>`:''}`;
  } catch(e){document.getElementById('perfilContent').innerHTML='<p style="padding:20px;text-align:center;color:var(--red);font-size:12px;">Error</p>';}
}

/* ATLETAS (COACH) */
function vAtletas(){
  render(`<div class="page-title">Atletas</div><div class="page-sub">Selecciona para ver perfil completo</div>
    ${S.athletes.map(a=>`<div class="ath-row" onclick="openAthProfile('${a.id}','${a.name}')">
      <div class="ath-avatar">${a.name.charAt(0)}</div>
      <div class="ath-info"><div class="ath-name">${a.name}</div><div class="ath-meta">Ver perfil ¬∑ Wave Score ¬∑ Historial</div></div>
      <span style="color:var(--grey);font-size:18px;">‚Ä∫</span>
    </div>`).join('')}`);
}
function openAthProfile(id,name){
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const btn=document.getElementById('nb-atletas'); if(btn) btn.classList.add('active');
  vPerfil(id,name);
}

/* BOOT */
async function boot(){
  showLoad(true);
  try {
    const ok=await restoreSession();
    if(ok){ await bootApp(); }
    else { document.getElementById('landingScreen').style.display='flex'; }
  } catch(e){ document.getElementById('landingScreen').style.display='flex'; }
  finally { showLoad(false); }
}
boot();
</script>
</body>
</html>
